/*! blog 2014-02-11 */
function getDataFromReportId(a,b,c){$.get("/reports/"+a).success(function(a){if(b.getDataFromAmazon)$.get(a.url).success(function(a){a=d3.csv.parse(a),c(a)});else{var d=d3.csv.parse(a.data);c(d)}})}function submitFileToS3(a,b){var c=function(a){a=a.replace(/.+[\\\/]/,""),$.ajax({url:"/signed",data:{title:a},type:"GET",dataType:"json",success:d,error:function(a,b,c){throw c}})},d=function(c){var d=new FormData;d.append("key",c.key),d.append("AWSAccessKeyId",c.AWSAccessKeyId),d.append("acl","public-read"),d.append("policy",c.policy),d.append("signature",c.signature),d.append("success_action_status","201"),d.append("Content-Type",c.contentType),d.append("file",a),$.ajax({url:"http://aedeveloper.s3.amazonaws.com/",type:"POST",processData:!1,contentType:!1,async:!1,data:d,dataType:"text",success:function(a){var c=$.parseXML(a),d=c.children[0].getElementsByTagName("Key")[0].innerHTML;b(d)},error:function(a,b,c){alert("Error uploading to amazon",c)}})};c(a.name)}d3.custom={charts:{}},d3.custom.charts.lineChart=function(){function a(a){a.each(function(a){b=d3.select(this).append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")");var m=ss.linear_regression().data(a.map(function(a){return[+a.x,+a.y]})).line(),n=d3.extent(a,f);n[1]=1.4*n[1];var o=n.map(function(a){return{x:+a,y:m(+a)}});h.range([0,d-c.left-c.right]).domain(d3.extent(n)),i.range([e-c.top-c.bottom,0]).domain(d3.extent(a,g)),b.append("g").attr("class","x axis").attr("transform","translate(0,"+(e-c.top-c.bottom)+")").call(j),b.append("g").attr("class","y axis").call(k).append("text").attr("transform","rotate(-90)"),b.append("path").datum(a).attr("class","line").attr("d",l),b.append("path").datum(o).attr("class","reg").attr("d",l)})}var b,c={top:20,right:20,bottom:30,left:50},d=760-c.left-c.right,e=120-c.top-c.bottom,f=function(a){return a[0]},g=function(a){return a[1]},h=d3.scale.linear(),i=d3.scale.linear(),j=d3.svg.axis().scale(h).orient("bottom"),k=d3.svg.axis().scale(i).orient("left"),l=d3.svg.line().x(function(a){return h(a.x)}).y(function(a){return i(a.y)});return a.margin=function(b){return arguments.length?(c=b,a):c},a.width=function(b){return arguments.length?(d=b,a):d},a.height=function(b){return arguments.length?(e=b,a):e},a.x=function(b){return arguments.length?(f=b,a):f},a.y=function(b){return arguments.length?(g=b,a):g},a},d3.custom.charts.barChart=function(){function a(a){a.each(function(a){var g=d,j=e-c.top-c.bottom,k=d3.scale.ordinal().domain(i(a)).rangeRoundBands([0,g],.1),l=d3.scale.linear().domain([0,d3.max(a,function(a){return+h(a)})]).range([j,0]),m=d3.svg.axis().scale(k).orient("bottom"),n=d3.svg.axis().scale(l).orient("left");if(!b){b=d3.select(this).append("svg").classed("chart",!0);var o=b.append("g").classed("container-group",!0);o.append("g").classed("chart-group",!0),o.append("g").classed("x-axis-group axis",!0),o.append("g").classed("y-axis-group axis",!0)}b.select(".container-group").attr({transform:"translate("+c.left+","+c.top+")"}),b.select(".x-axis-group.axis").attr({transform:"translate(0,"+j+")"}).call(m),b.select(".y-axis-group.axis").call(n);var p=k.rangeBand()/100*f,q=k.rangeBand()-p,r=b.select(".chart-group").selectAll(".bar").data(a);r.enter().append("rect").classed("bar",!0).attr({x:g,width:q,y:function(a){return l(h(a))},height:function(a){return j-l(h(a))}}),r.transition().attr({width:q,x:function(a,b){return k(b)+p/2},y:function(a){return l(h(a))},height:function(a){return j-l(h(a))}}),r.exit().transition().style({opacity:0}).remove()})}var b,c={top:20,right:20,bottom:40,left:40},d=500,e=500,f=0,g=function(a){return a[0]},h=function(a){return a[1]},i=function(a){return a.map(function(a,b){return+b})};return a.width=function(a){return arguments.length?(d=parseInt(a),this):d},a.height=function(a){return arguments.length?(e=parseInt(a),this):e},a.gap=function(a){return arguments.length?(f=a,this):f},a.x=function(b){return arguments.length?(g=b,a):g},a.xDomain=function(b){return arguments.length?(i=b,a):i},a.y=function(b){return arguments.length?(h=b,a):h},a};var AentropicoApp=angular.module("AentropicoApp",["angularFileUpload","ngRoute"]);AentropicoApp.config(function(a){a.when("/about",{templateUrl:"../README.html",controller:"aboutController"}).when("/reports/:reportId",{templateUrl:"../html/upload.html",controller:"uploadController"}).when("/reports",{templateUrl:"../html/upload.html",controller:"uploadController"}).otherwise({redirectTo:"/reports"})}),AentropicoApp.controller("uploadController",["$scope","$http","$upload","$location","$routeParams",function(a,b,c,d,e){$("input[type=file]").focus(),a.buildGraph=function(b,c){$(c).empty();var d={line:d3.custom.charts.lineChart,bar:d3.custom.charts.barChart},e=d[b]().width($(c).width()).height($(c).width()/2).x(function(a){return+a.x}).y(function(a){return+a.y});d3.select(c).datum(a.data).call(e)},e.reportId&&($("#percent-complete").width("100%"),getDataFromReportId(e.reportId,{getDataFromAmazon:!1},function(b){var c="line",d="#graph";a.data=b,a.buildGraph(c,d)})),a.onFileSelect=function(b){var e=$("#percent-complete");e.width("0%").parent().show();{var f=b[0];submitFileToS3(f,function(b){var g="https://s3.amazonaws.com/aedeveloper/"+b;a.upload=c.upload({url:"/csv",method:"POST",file:f,data:{url:g}}).then(function(a){if(!a.data.success)throw a.data.message;d.path("reports/"+a.data.reportId)},null,function(a){e.width(parseInt(100*a.loaded/a.total)+"%")})})}}}]),AentropicoApp.controller("aboutController",["$scope",function(){}]);